#! /bin/sh
#
# build : hostname -> system-path
#
set -euf

host=$1

#target=root@$host

pubkeys=$config_root/pubkeys
nixpkgs=$nixpkgs_root/$host
nixos_config=$config_root/modules/$host
secrets_nix=$secrets_root/$host/nix
secrets_rsync=$secrets_root/$host/rsync

# Notice how host's NIX_PATH is used to prefetch nixpkgs.
NIXOS_CONFIG=$nixos_config \
  prefetch nixpkgs tmp/nixpkgs/$host

nix-build \
    -I "$nixpkgs" \
    -I pubkeys="$pubkeys" \
    -I nixos-config="$nixos_config" \
    -I retiolum-hosts="$retiolum_hosts" \
    -I secrets="$secrets_nix" \
    -A system \
    --no-out-link \
    '<nixos>'
