#! /bin/sh
#
# build : hostname -> system-path
#
set -euf

host=$1

NIXOS_CONFIG=$config_root/modules/$host
export NIXOS_CONFIG

# Notice how host's NIX_PATH is used to prefetch nixpkgs.
prefetch nixpkgs "$nixpkgs_root/$host"

NIX_PATH=$nixpkgs_root/$host
NIX_PATH=$NIX_PATH:secrets=$secrets_root/$host/nix
NIX_PATH=$NIX_PATH:pubkeys=$config_root/pubkeys
NIX_PATH=$NIX_PATH:retiolum-hosts=$retiolum_hosts
export NIX_PATH

exec nix-build \
  -A system \
  --no-out-link \
  '<nixos>'
